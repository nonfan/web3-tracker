# 价格数据自动更新功能说明

## 功能概述

实现了智能的价格数据自动更新机制，无需手动导入，点击"价格走势"即可自动获取最新数据。

## 核心功能

### 1. 自动获取价格数据

**触发时机：** 点击代币卡片的"价格走势"按钮

**智能判断：**
- ✅ 如果代币没有 CoinGecko ID → 打开导入器，让用户搜索并绑定代币
- ✅ 如果有 CoinGecko ID 但没有价格数据 → 自动从 API 获取
- ✅ 如果有价格数据但超过1小时 → 自动更新数据
- ✅ 如果有价格数据且在1小时内 → 直接显示图表

**用户体验：**
- 按钮显示"更新中..."状态
- 加载动画（旋转图标）
- 自动缓存数据，避免重复请求

### 2. 手动刷新功能

**位置：** 价格图表弹窗右上角的刷新按钮

**功能：**
- 随时手动刷新价格数据
- 更新后自动保存到缓存
- 显示最后更新时间

### 3. 数据缓存机制

**缓存策略：**
- 自动缓存：每次获取数据后自动缓存1小时
- 智能使用：1小时内直接使用缓存，超过1小时自动更新
- 手动刷新：忽略缓存，强制从 API 获取最新数据

**缓存信息：**
- 存储位置：localStorage
- 缓存时长：1小时
- 缓存键：`代币ID_天数`

## 使用流程

### 首次使用

1. 创建代币
2. 点击"价格走势"按钮
3. 在弹出的导入器中搜索代币
4. 选择正确的代币并导入
5. 系统自动绑定 CoinGecko ID
6. 显示价格图表

### 后续使用

1. 点击"价格走势"按钮
2. 系统自动判断是否需要更新：
   - 数据新鲜（<1小时）→ 直接显示
   - 数据过期（>1小时）→ 自动更新后显示
3. 查看价格图表
4. 需要最新数据时，点击刷新按钮

## 技术实现

### 数据流程

```
点击"价格走势"
    ↓
检查是否有 coingeckoId
    ↓ 无
打开导入器 → 搜索并绑定代币
    ↓ 有
检查最后更新时间
    ↓
< 1小时：直接显示图表
> 1小时：自动更新数据 → 显示图表
```

### 关键字段

在 Token 类型中添加：
- `coingeckoId`: CoinGecko 代币 ID（用于后续自动更新）
- `lastPriceUpdate`: 最后更新时间戳
- `currentPrice`: 当前价格
- `priceHistory`: 价格历史数据

### API 调用优化

**减少 API 调用：**
1. 首次导入：1次 API 调用
2. 1小时内查看：0次 API 调用（使用缓存）
3. 超过1小时：1次 API 调用（自动更新）
4. 手动刷新：1次 API 调用

**对比传统方式：**
- 传统：每次查看都需要手动导入（多次 API 调用）
- 现在：自动管理，最多1小时1次调用

## 用户界面

### 价格走势按钮

**状态显示：**
- 正常：`价格走势` + 📈 图标
- 更新中：`更新中...` + 🔄 旋转图标
- 禁用：按钮变灰，不可点击

### 价格图表弹窗

**新增元素：**
- 刷新按钮：右上角，随时手动更新
- 更新时间：显示"最后更新: YYYY-MM-DD HH:MM:SS"
- 加载状态：刷新时按钮显示旋转动画

## 优势

✅ **用户体验优化：**
- 一键查看，无需手动导入
- 自动更新，数据始终新鲜
- 智能缓存，响应速度快

✅ **性能优化：**
- 减少 API 调用次数
- 避免触发 API 限制
- 节省网络流量

✅ **数据管理：**
- 自动绑定代币 ID
- 记录更新时间
- 支持手动刷新

## 注意事项

1. **首次使用**：需要搜索并绑定代币，之后自动管理
2. **网络要求**：需要稳定的网络连接访问 CoinGecko API
3. **更新频率**：建议不要频繁手动刷新，避免触发 API 限制
4. **数据延迟**：CoinGecko 数据可能有几分钟延迟

## 未来改进

- [ ] 支持自定义更新间隔（30分钟、1小时、2小时等）
- [ ] 后台自动更新（定时任务）
- [ ] 批量更新所有代币价格
- [ ] 价格变动通知
- [ ] 更多时间范围选择（7天、30天、90天等）
